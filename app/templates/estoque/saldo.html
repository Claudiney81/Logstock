{% extends 'base.html' %}
{% block content %}
<div class="container-fluid mt-3">
  <div class="card shadow-sm">
    <!-- TOPO AZUL -->
    <div class="card-header" style="background-color: #002b55; color: white;">
      <h5 class="fw-semibold mb-0">
        <i class="bi bi-box-seam me-2"></i>
        Saldo de Estoque
        {% if tipo_servico %}
          <span class="fw-light">
            - {{ tipos_servico|selectattr('id','equalto',tipo_servico|int)|map(attribute='nome')|first }}
          </span>
        {% endif %}
      </h5>
    </div>

    <div class="card-body">
      <!-- FILTRO -->
      <form method="get" action="{{ url_for('estoque.saldo_estoque') }}" class="mb-3">
        <div class="row g-3">
          <div class="col-md-4">
            <label for="tipo_servico" class="form-label">Tipo de Serviço</label>
            <select id="tipo_servico" name="tipo_servico" class="form-select" onchange="this.form.submit()">
              <option value="" {% if not tipo_servico %}selected{% endif %}>Todos</option>
              {% for ts in tipos_servico %}
                <option value="{{ ts.id }}" {% if tipo_servico|int == ts.id %}selected{% endif %}>{{ ts.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Responsável</label>
            <input type="text" class="form-control" value="{{ responsavel or '-' }}" readonly>
          </div>
        </div>
      </form>

      {% if tipo_servico %}
        <div class="alert alert-info py-2">
          Exibindo saldo apenas para o tipo de serviço selecionado.
        </div>
      {% endif %}

      <!-- TABELA -->
      <form method="post" action="{{ url_for('estoque.atualizar_minimos') }}">
        <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
          <table class="table table-bordered table-hover table-striped align-middle table-sm">
            <thead style="position: sticky; top: 0; z-index: 10; background-color: #002b55; color: white;">
              <tr>
                <th style="width: 90px;">Código</th>
                <th style="width: 280px;">Descrição</th>
                <th style="width: 90px;">Unidade</th>
                <th style="width: 110px;">Valor (R$)</th>
                <th style="width: 100px;">Quantidade</th>
                <th style="width: 130px;">Estoque Mínimo</th>
                <th style="width: 150px;">Endereço</th>
              </tr>
            </thead>
            <tbody>
              {% if resultados %}
                {% for estoque, item in resultados %}
                <tr>
                  <td>{{ item.codigo }}</td>
                  <td class="text-truncate" style="max-width: 280px;">{{ item.descricao }}</td>
                  <td>{{ item.unidade }}</td>
                  <td>{{ "%.2f"|format(item.valor) }}</td>
                  <td class="{% if estoque.quantidade <= (estoque.quantidade_minima or 0) %}table-danger fw-bold{% endif %}">
                    {{ estoque.quantidade }}
                  </td>
                  <td>
                    <input type="text"
                           name="minimos[{{ estoque.id }}]"
                           value="{{ estoque.quantidade_minima or '' }}"
                           class="form-control form-control-sm"
                           placeholder="Ex: 10 ou 30%">
                  </td>
                  <td>
                    <input type="text"
                           name="enderecos[{{ estoque.id }}]"
                           value="{{ estoque.endereco or '' }}"
                           class="form-control form-control-sm"
                           placeholder="Ex: 1-A-23">
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="7" class="text-center text-muted">Nenhum registro encontrado.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <div class="text-end mt-3">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1"></i>Salvar Alterações
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
