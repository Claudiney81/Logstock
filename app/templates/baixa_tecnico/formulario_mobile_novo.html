{% extends 'base.html' %} {% block content %}
<div class="container mt-3">
  <h4 class="text-primary">
    <i class="bi bi-phone"></i> Baixa Técnica - {{ tecnico_nome }}
  </h4>

  <form
    method="POST"
    action="{{ url_for('baixa_tecnico.registrar') }}"
    id="form-baixa"
  >
    <input type="hidden" name="tecnico_id" value="{{ tecnico_id }}" />

    <!-- Tipo de Serviço -->
    <div class="mb-3">
      <label for="tipo_servico_id" class="form-label">Tipo de Serviço</label>
      <select
        class="form-select"
        name="tipo_servico_id"
        id="tipo_servico_id"
        required
      >
        <option value="">Selecione</option>
        {% for ts in tipos_servico %}
        <option value="{{ ts.id }}">{{ ts.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Responsável -->
    <div class="mb-3">
      <label for="responsavel" class="form-label">Responsável</label>
      <input
        type="text"
        class="form-control"
        name="responsavel"
        id="responsavel"
        required
      />
    </div>

    <!-- Observação -->
    <div class="mb-3">
      <label for="observacao" class="form-label">Observação</label>
      <input
        type="text"
        class="form-control"
        name="observacao"
        id="observacao"
      />
    </div>

    <!-- Itens -->
    <div id="itens-container" class="mt-4">
      <h6 class="text-muted">
        Selecione um Tipo de Serviço para carregar os itens...
      </h6>
    </div>

    <div class="text-center mt-4">
      <button type="submit" class="btn btn-success px-4">
        <i class="bi bi-check-circle"></i> Enviar Baixa
      </button>
    </div>
  </form>
</div>

<script>
  document.getElementById('tipo_servico_id').addEventListener('change', function() {
    const tecnicoId = {{ tecnico_id }};
    const tipoServicoId = this.value;
    const container = document.getElementById('itens-container');
    container.innerHTML = '<p class="text-info">Carregando itens...</p>';

    if (!tipoServicoId) return;

    fetch(`/baixa_tecnico/api/itens/${tecnicoId}/${tipoServicoId}`)
      .then(response => response.json())
      .then(data => {
        if (!data.itens.length) {
          container.innerHTML = '<div class="alert alert-warning">Nenhum item disponível para este serviço.</div>';
          return;
        }
        let html = `
          <table class="table table-bordered table-sm">
            <thead class="table-light">
              <tr class="text-center">
                <th>Código</th>
                <th>Descrição</th>
                <th>Unidade</th>
                <th>Saldo</th>
                <th>Qtd. Baixa</th>
              </tr>
            </thead>
            <tbody>
        `;
        data.itens.forEach(i => {
          html += `
            <tr>
              <td>${i.codigo}</td>
              <td>${i.descricao}</td>
              <td>${i.unidade}</td>
              <td class="text-center">${i.saldo}</td>
              <td class="text-center">
                <input type="number" name="quantidade[]" max="${i.saldo}" min="0" step="1" class="form-control form-control-sm">
                <input type="hidden" name="item_id[]" value="${i.item_id}">
              </td>
            </tr>
          `;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      })
      .catch(() => {
        container.innerHTML = '<div class="alert alert-danger">Erro ao carregar itens.</div>';
      });
  });
</script>
{% endblock %}
