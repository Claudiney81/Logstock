{% extends 'base.html' %}
{% block title %}Nova Transferência Externa{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4 text-primary">
    <i class="bi bi-box-arrow-up-right me-2"></i> Nova Transferência Externa
  </h2>

  <form method="POST" action="{{ url_for('transferencia_externa.registrar_transferencia_externa') }}" autocomplete="off">
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label for="empresa_id" class="form-label fw-semibold">Empresa/Parceiro</label>
        <select class="form-select shadow-sm" name="empresa_id" id="empresa_id" required>
          <option value="">Selecione</option>
          {% for empresa in empresas %}
            <option value="{{ empresa.id }}">{{ empresa.razao_social }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label for="cnpj" class="form-label fw-semibold">CNPJ</label>
        <input type="text" class="form-control shadow-sm" id="cnpj" readonly>
      </div>
      <div class="col-md-3">
        <label for="endereco" class="form-label fw-semibold">Endereço</label>
        <input type="text" class="form-control shadow-sm" id="endereco" readonly>
      </div>
      <div class="col-md-3">
        <label for="contato" class="form-label fw-semibold">Contato</label>
        <input type="text" class="form-control shadow-sm" id="contato" readonly>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label for="autorizado_por" class="form-label fw-semibold">Autorizado por</label>
        <input type="text" class="form-control shadow-sm" name="autorizado_por" required>
      </div>
      <div class="col-md-4">
        <label for="retirado_por" class="form-label fw-semibold">Retirado por</label>
        <input type="text" class="form-control shadow-sm" name="retirado_por" required>
      </div>
      <div class="col-md-4">
        <label for="tipo_servico_id" class="form-label fw-semibold">Tipo de Serviço</label>
        <select class="form-select shadow-sm" id="tipo_servico_id" name="tipo_servico_id" required>
          <option value="">Selecione</option>
          {% for ts in tipos_servico %}
            <option value="{{ ts.id }}">{{ ts.nome }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <h5 class="fw-semibold mt-4 mb-2">
      <i class="bi bi-box-seam me-2"></i> Itens da Transferência
    </h5>
    <div class="table-responsive shadow-sm rounded border">
      <table class="table table-bordered table-sm align-middle mb-0" id="tabela-itens">
        <thead class="table-light">
          <tr>
            <th style="width:12%;">Código</th>
            <th style="width:35%;">Descrição</th>
            <th style="width:10%;">Unidade</th>
            <th style="width:10%;">Qtd</th>
            <th style="width:12%;">Valor (R$)</th>
            <th style="width:10%;">Saldo</th>
            <th style="width:11%;">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="text" name="codigo[]" class="form-control form-control-sm codigo-input" readonly /></td>
            <td>
              <select name="descricao[]" class="form-select form-select-sm descricao-select" required>
                <option value="">Selecione</option>
              </select>
            </td>
            <td><input type="text" name="unidade[]" class="form-control form-control-sm unidade-input" readonly /></td>
            <td><input type="number" name="quantidade[]" min="1" class="form-control form-control-sm" /></td>
            <td><input type="number" name="valor_unitario[]" step="0.01" class="form-control form-control-sm valor-input" readonly /></td>
            <td class="saldo-cell"><span class="saldo-info"></span></td>
            <td class="text-center">
              <button type="button" class="btn btn-success btn-sm" onclick="inserirLinha()" title="Inserir nova linha">
                <i class="bi bi-plus"></i>
              </button>
              <button type="button" class="btn btn-danger btn-sm excluir-btn" style="opacity:0.5; pointer-events:none;" onclick="removerLinha(this, true)" title="Excluir linha">
                <i class="bi bi-x"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <button type="submit" class="btn btn-primary mt-3 shadow-sm">
      <i class="bi bi-save"></i> Registrar Transferência
    </button>
  </form>
</div>

<script>
let itensDisponiveis = [];

// Preenche dados da empresa
document.getElementById("empresa_id").addEventListener("change", function () {
  const empresaId = this.value;
  if (!empresaId) return;
  fetch(`/transferencias/externa/empresa/${empresaId}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("cnpj").value = data.cnpj || '';
      document.getElementById("endereco").value = data.endereco || '';
      document.getElementById("contato").value = data.contato || '';
    });
});

// Atualiza lista de itens do tipo de serviço
function atualizarListaDeItens() {
  const tipoServicoId = document.getElementById("tipo_servico_id").value;
  if (!tipoServicoId) return;

  fetch(`/transferencias/externa/api/itens_disponiveis?tipo_servico_id=${tipoServicoId}`)
    .then(res => res.json())
    .then(data => {
      itensDisponiveis = data;
      document.querySelectorAll('.descricao-select').forEach(select => {
        const valorAtual = select.value;
        select.innerHTML = '<option value="">Selecione</option>';
        data.forEach(item => {
          const option = document.createElement('option');
          option.value = item.codigo;
          option.textContent = item.descricao;
          select.appendChild(option);
        });
        select.value = valorAtual;
      });

      // Limpa campos da primeira linha
      document.querySelectorAll('.codigo-input, .unidade-input, .valor-input').forEach(el => el.value = '');
      document.querySelectorAll('.saldo-info').forEach(el => el.innerText = '');
    });
}
document.getElementById("tipo_servico_id").addEventListener("change", atualizarListaDeItens);

// Preenche campos quando seleciona descrição
document.querySelector('#tabela-itens tbody').addEventListener('change', function (e) {
  if (e.target.classList.contains('descricao-select')) {
    const codigo = e.target.value;
    const tr = e.target.closest('tr');
    const item = itensDisponiveis.find(i => i.codigo === codigo);
    if (item) {
      tr.querySelector('.codigo-input').value = item.codigo;
      tr.querySelector('.unidade-input').value = item.unidade;
      tr.querySelector('.valor-input').value = parseFloat(item.valor || 0).toFixed(2);
      tr.querySelector('.saldo-info').innerText = item.saldo ?? 0;
    }
  }
});

// Adiciona nova linha
function inserirLinha() {
  const tbody = document.querySelector('#tabela-itens tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" name="codigo[]" class="form-control form-control-sm codigo-input" readonly /></td>
    <td><select name="descricao[]" class="form-select form-select-sm descricao-select" required><option value="">Selecione</option></select></td>
    <td><input type="text" name="unidade[]" class="form-control form-control-sm unidade-input" readonly /></td>
    <td><input type="number" name="quantidade[]" min="1" class="form-control form-control-sm" /></td>
    <td><input type="number" name="valor_unitario[]" step="0.01" class="form-control form-control-sm valor-input" readonly /></td>
    <td class="saldo-cell"><span class="saldo-info"></span></td>
    <td class="text-center">
      <button type="button" class="btn btn-success btn-sm" onclick="inserirLinha()"><i class="bi bi-plus"></i></button>
      <button type="button" class="btn btn-danger btn-sm excluir-btn" onclick="removerLinha(this, false)"><i class="bi bi-x"></i></button>
    </td>`;
  tbody.appendChild(tr);
  atualizarListaDeItens();
}

// Remove linha
function removerLinha(btn, isFirstLine) {
  const tr = btn.closest('tr');
  const tbody = tr.parentElement;
  if (isFirstLine && tbody.rows.length === 1) {
    tr.querySelectorAll('input, select').forEach(input => input.value = '');
    tr.querySelectorAll('.saldo-info').forEach(span => span.innerText = '');
    return;
  }
  tr.remove();
}

// Carrega lista ao abrir página
document.addEventListener("DOMContentLoaded", atualizarListaDeItens);
</script>
{% endblock %}
