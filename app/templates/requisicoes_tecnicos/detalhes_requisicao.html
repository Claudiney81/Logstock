{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">

    <!-- Cabeçalho fixo -->
    <div class="card shadow-sm border-primary mb-4 position-sticky top-0 z-3" style="z-index: 999;">
        <div class="card-header bg-primary text-white">
            <strong>Informações da Requisição</strong>
        </div>
        <div class="card-body">
            <div class="row mb-2">
                <div class="col-md-4"><strong>Solicitante:</strong> {{ requisicao.solicitante_responsavel }}</div>
                <div class="col-md-4"><strong>Resp. Projeto:</strong> {{ requisicao.resp_projeto }}</div>
                <div class="col-md-4"><strong>Técnico:</strong> {{ requisicao.solicitante_tecnico }}</div>
            </div>
            <div class="row mb-2">
                <!-- Aqui exibimos o nome salvo diretamente na requisição -->
                <div class="col-md-4"><strong>Tipo de Serviço:</strong> {{ requisicao.tipo_servico or 'Não informado' }}</div>
                <div class="col-md-4"><strong>Data/Hora:</strong> {{ requisicao.data_hora.strftime('%d/%m/%Y %H:%M') }}</div>
                <div class="col-md-4"><strong>Observação:</strong> {{ requisicao.observacao or '' }}</div>
            </div>
        </div>
    </div>

    <!-- Tabela de Itens -->
    <form method="post">
    <div class="card shadow-sm border-secondary mb-4">
        <div class="card-header bg-secondary text-white">
            <strong>Itens da Requisição</strong>
        </div>
        <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Código</th>
                        <th>Descrição</th>
                        <th>Quantidade</th>
                        <th>Unidade</th>
                        <th>Estoque Atual</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in requisicao.itens %}
                    <tr>
                        <td>{{ item.codigo }}</td>
                        <td>{{ item.descricao }}</td>
                        <td>
                            {% if not status_bloqueado %}
                                <input type="number" name="quantidade_{{ item.id }}" 
                                       value="{{ item.quantidade }}" 
                                       class="form-control form-control-sm">
                            {% else %}
                                {{ item.quantidade }}
                            {% endif %}
                        </td>
                        <td>{{ item.unidade }}</td>
                        <td>{{ saldos[item.codigo] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Assinatura se existir -->
    {% if requisicao.assinatura_path %}
    <div class="card shadow-sm border-success mb-4 text-center">
        <div class="card-header bg-success text-white">
            <strong>Assinatura do Técnico</strong>
        </div>
        <div class="card-body">
            <img src="{{ url_for('static', filename=requisicao.assinatura_path) }}" 
                 alt="Assinatura do Técnico" class="img-fluid" style="max-height: 200px;">
        </div>
    </div>
    {% endif %}

    <!-- Alterar Status -->
    <div class="card shadow-sm p-3 mb-4">
        <h5 class="mb-3">Atualizar Status</h5>
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">Status:</label>
                <select name="status" class="form-select" {% if status_bloqueado %}disabled{% endif %}>
                    <option value="pendente" {% if requisicao.status == "pendente" %}selected{% endif %}>Pendente</option>
                    <option value="material_entregue" {% if requisicao.status == "material_entregue" %}selected{% endif %}>Material Entregue</option>
                </select>
            </div>
            <div class="col-md-8">
                <label class="form-label">Observação do Estoque:</label>
                <textarea name="observacao_estoque" rows="2" class="form-control">{{ requisicao.observacao_estoque or '' }}</textarea>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <a href="{{ url_for('requisicoes_tecnicos.historico') }}" class="btn btn-secondary me-2">← Voltar</a>
            {% if not status_bloqueado %}
            <button type="submit" class="btn btn-primary">Finalizar Requisição</button>
            {% endif %}
        </div>
    </div>
    </form>
</div>
{% endblock %}
