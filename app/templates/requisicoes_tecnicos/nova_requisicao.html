{% extends "base.html" %} {% block content %}
<div class="container">
  <h2 class="mb-4">Nova Requisição – Técnicos</h2>

  <form method="post">
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">Solicitante:</label>
        <input
          type="text"
          name="solicitante_responsavel"
          class="form-control form-control-sm"
          required
        />
      </div>

      <div class="col-md-4">
        <label class="form-label">Técnico:</label>
        <select
          name="solicitante_tecnico"
          class="form-control form-control-sm"
          required
        >
          <option value="">Selecione</option>
          {% for tecnico in tecnicos %}
          <option value="{{ tecnico.nome }}">{{ tecnico.nome }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Tipo de Serviço:</label>
        <select
          name="tipo_servico"
          class="form-control form-control-sm"
          id="tipo-servico-select"
          required
        >
          <option value="">Selecione</option>
          {% for tipo in tipos_servico %}
          <option value="{{ tipo.id }}">{{ tipo.nome }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="row g-2 mb-3">
      <div class="col-md-6">
        <label class="form-label">Resp. Projeto:</label>
        <input
          type="text"
          name="resp_projeto"
          class="form-control form-control-sm"
          required
        />
      </div>
      <div class="col-md-6">
        <label class="form-label">Observação:</label>
        <input
          type="text"
          name="observacao"
          class="form-control form-control-sm"
        />
      </div>
    </div>

    <h4>Itens da Requisição</h4>
    <table class="table table-bordered" id="tabela-itens">
      <thead class="table-light">
        <tr>
          <th>Código</th>
          <th>Descrição</th>
          <th>Unidade</th>
          <th>Quantidade</th>
          <th>Valor</th>
          <th>Qtd. em Estoque</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button
      type="button"
      class="btn btn-secondary mb-3"
      onclick="adicionarLinha()"
    >
      + Adicionar Item</button
    ><br />
    <button type="submit" class="btn btn-primary">Enviar Requisição</button>
  </form>
</div>

<script>
  let tipoServicoId = "";

  document
    .getElementById("tipo-servico-select")
    .addEventListener("change", function () {
      tipoServicoId = this.value;
    });

  function adicionarLinha() {
    if (!tipoServicoId) {
      alert("Selecione o Tipo de Serviço antes de adicionar um item.");
      return;
    }

    const tbody = document.querySelector("#tabela-itens tbody");
    const linha = document.createElement("tr");

    linha.innerHTML = `
      <td>
        <select name="codigo[]" class="form-control form-control-sm codigo-select" onchange="preencherCampos(this)">
          <option value="">Carregando...</option>
        </select>
      </td>
      <td><input name="descricao[]" class="form-control form-control-sm descricao" readonly /></td>
      <td><input name="unidade[]" class="form-control form-control-sm unidade" readonly /></td>
      <td><input name="quantidade[]" type="number" min="1" class="form-control form-control-sm" required /></td>
      <td><input name="valor[]" type="number" step="0.01" class="form-control form-control-sm valor" readonly /></td>
      <td><input name="quantidade_estoque[]" class="form-control form-control-sm estoque" readonly /></td>
      <td><button type="button" class="btn btn-sm btn-danger" onclick="removerLinha(this)">Excluir</button></td>
    `;

    tbody.appendChild(linha);
    carregarItensNaLinha(linha.querySelector(".codigo-select"));
  }

  function removerLinha(botao) {
    const linha = botao.closest("tr");
    linha.remove();
  }

  function carregarItensNaLinha(select) {
    if (!tipoServicoId) return;
    fetch(
      `/requisicoes_tecnicos/api/itens_disponiveis?tipo_servico_id=${tipoServicoId}`
    )
      .then((res) => res.json())
      .then((data) => {
        select.innerHTML = '<option value="">Selecione...</option>';
        data.forEach((item) => {
          const option = document.createElement("option");
          option.value = item.codigo;
          option.textContent = `${item.codigo} - ${item.descricao}`;
          option.dataset.descricao = item.descricao;
          option.dataset.unidade = item.unidade;
          option.dataset.valor = item.valor;
          option.dataset.estoque = item.quantidade_estoque;
          select.appendChild(option);
        });
      })
      .catch(() => {
        select.innerHTML = '<option value="">Erro ao carregar</option>';
      });
  }

  function preencherCampos(select) {
    const selected = select.selectedOptions[0];
    const linha = select.closest("tr");
    linha.querySelector(".descricao").value = selected.dataset.descricao || "";
    linha.querySelector(".unidade").value = selected.dataset.unidade || "";
    linha.querySelector(".valor").value = selected.dataset.valor || "";
    linha.querySelector(".estoque").value = selected.dataset.estoque || "";
  }
</script>
{% endblock %}
