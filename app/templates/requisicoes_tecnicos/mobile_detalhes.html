<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atender Requisi√ß√£o</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .input-qtd { width: 80px; text-align: center; }
    .scroll-table { max-height: 260px; overflow-y: auto; }
    canvas { display: block; margin: 0 auto; border: 2px solid #666; border-radius: 6px; touch-action: none; }
    footer { margin-top: 2rem; font-size: 0.9rem; text-align: center; color: #6c757d; }
    .titulo-pagina { font-weight: 700; color: #0d6efd; }
    .card-header { font-weight: bold; }
    .table th, .table td { vertical-align: middle; text-align: center; }
  </style>
</head>
<body>
  <div class="container py-3">
    <h4 class="mb-2 text-center titulo-pagina">üìã Requisi√ß√µes Pendentes</h4>
    <h6 class="text-center text-secondary mb-4">Atender Requisi√ß√£o</h6>

    <!-- Cabe√ßalho -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <p class="mb-1"><strong>Solicitante:</strong> {{ requisicao.solicitante_responsavel }}</p>
        <p class="mb-1"><strong>Resp. Projeto:</strong> {{ requisicao.resp_projeto or '' }}</p>
        <p class="mb-1"><strong>Tipo Servi√ßo:</strong> {{ requisicao.tipo_servico }}</p>
        <p class="mb-1"><strong>T√©cnico:</strong> {{ requisicao.solicitante_tecnico }}</p>
        <p class="mb-0"><strong>Data/Hora:</strong> {{ requisicao.data_hora.strftime('%d/%m/%Y %H:%M') }}</p>
      </div>
    </div>

    <!-- Formul√°rio -->
    <form method="POST">
      <div class="card mb-3 shadow-sm">
        <div class="card-header bg-primary text-white">Itens da Requisi√ß√£o</div>
        <div class="card-body p-0 scroll-table table-responsive">
          <table class="table table-sm table-striped table-bordered mb-0">
            <thead class="table-light">
              <tr>
                <th>C√≥digo</th>
                <th>Descri√ß√£o</th>
                <th>Qtd</th>
                <th>Estoque</th>
                <th>Saldo T√©cnico</th>
                <th>Endere√ßo</th>
              </tr>
            </thead>
            <tbody>
              {% for item in requisicao.itens %}
              <tr>
                <td>{{ item.codigo }}</td>
                <td class="text-start">{{ item.descricao }}</td>
                <td>
                  <input type="number" name="quantidade_{{ item.id }}" 
                         value="{{ item.quantidade }}" 
                         min="1" required 
                         class="form-control form-control-sm input-qtd"/>
                </td>
                <td>{{ saldos_estoque[item.codigo] }}</td>
                <td>{{ saldos_tecnico[item.codigo] }}</td>
                <td>{{ enderecos_itens[item.codigo] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Assinatura -->
      <h6 class="text-center mt-3 mb-2">Assinatura do T√©cnico</h6>
      <canvas id="assinatura" class="mb-2 w-100" height="300"></canvas>
      <div class="text-center mb-3">
        <button type="button" class="btn btn-secondary btn-sm" onclick="limparAssinatura()">Limpar</button>
      </div>

      <input type="hidden" name="assinatura" id="assinaturaInput" />
      <button type="submit" class="btn btn-success btn-lg w-100">Finalizar e Enviar</button>
    </form>
  </div>

  <footer>¬© 2025 LogiStock - Sistema Mobile</footer>

  <script>
    const canvas = document.getElementById("assinatura");
    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = 300 * ratio;
      canvas.getContext("2d").scale(ratio, ratio);
      signaturePad.clear();
    }
    const signaturePad = new SignaturePad(canvas, { throttle: 0, minWidth: 0.8, maxWidth: 2.5 });
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
    function limparAssinatura() { signaturePad.clear(); }
    document.querySelector("form").addEventListener("submit", function () {
      document.getElementById("assinaturaInput").value = signaturePad.toDataURL();
    });
  </script>
</body>
</html>
