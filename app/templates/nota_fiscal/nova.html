{% extends 'base.html' %} {% block content %}
<div class="container mt-4">
  <h4 class="mb-4"><i class="bi bi-file-earmark-plus"></i> Nova Nota Fiscal</h4>

  <!-- Mensagens de feedback -->
  <div class="d-flex justify-content-center">
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %}
    <div
      class="alert alert-{{ category }} flash-message mt-2 mb-2 p-2 shadow-sm"
      style="max-width: 360px; font-size: 1rem; text-align: center"
    >
      {{ message }}
    </div>
    {% endfor %} {% endif %} {% endwith %}
  </div>
  <script>
    setTimeout(
      () =>
        document
          .querySelectorAll(".flash-message")
          .forEach((el) => (el.style.display = "none")),
      3000
    );
  </script>

  <!-- Formulário principal -->
  <form
    method="POST"
    action="{{ url_for('nota_fiscal.nova_nota') }}"
    onsubmit="return validarItens()"
  >
    <div class="row mb-2">
      <div class="col-md-3">
        <label>Número NF</label>
        <input type="text" name="numero_nf" class="form-control" required />
      </div>
      <div class="col-md-3">
        <label>Reserva</label>
        <input type="text" name="reserva" class="form-control" />
      </div>
      <div class="col-md-3">
        <label>Tipo de Serviço</label>
        <select
          name="tipo_servico_id"
          id="tipo_servico_id"
          class="form-select"
          required
        >
          <option value="">Selecione</option>
          {% for tipo in tipos_servico %}
          <option value="{{ tipo.id }}">{{ tipo.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label>Resp.Projeto</label>
        <input
          type="text"
          name="responsavel"
          id="responsavel"
          class="form-control"
        />
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-12">
        <label>Observações</label>
        <textarea name="observacao" class="form-control" rows="2"></textarea>
      </div>
    </div>

    <!-- Adicionar item (fixo) -->
    <div
      class="bg-white border rounded shadow-sm p-3 mb-2 sticky-top"
      style="top: 70px; z-index: 1020"
    >
      <h5 class="fw-bold">Adicionar Item</h5>
      <div class="row align-items-end">
        <div class="col-md-2">
          <label>Código</label>
          <input type="text" id="codigo" class="form-control" readonly />
        </div>
        <div class="col-md-3">
          <label>Descrição</label>
          <select id="descricao" class="form-select">
            <option value="">Selecione um item...</option>
          </select>
        </div>
        <div class="col-md-2">
          <label>Quantidade</label>
          <input type="number" id="quantidade" class="form-control" min="1" />
        </div>
        <div class="col-md-2">
          <label>Valor Unit.</label>
          <input type="text" id="valor" class="form-control" readonly />
        </div>
        <div class="col-md-1 d-grid">
          <button
            type="button"
            class="btn btn-primary"
            onclick="adicionarItem()"
          >
            Adicionar
          </button>
        </div>
        <div class="col-md-2">
          <label>Importar Itens (.xlsx)</label>
          <input
            type="file"
            id="importarExcel"
            accept=".xlsx"
            class="form-control"
          />
        </div>
      </div>
    </div>

    <!-- Tabela de itens -->
    <div style="max-height: 300px; overflow-y: auto">
      <table class="table table-bordered table-sm">
        <thead
          class="table-light"
          style="position: sticky; top: 0; z-index: 2; background: white"
        >
          <tr>
            <th>Código</th>
            <th>Descrição</th>
            <th>Quantidade</th>
            <th>Valor Unitário</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody id="tabela-itens"></tbody>
      </table>
    </div>

    <div class="mt-3">
      <button type="submit" class="btn btn-success">Salvar Nota Fiscal</button>
      <button type="reset" class="btn btn-secondary" onclick="limparItens()">
        Limpar
      </button>
    </div>
  </form>
</div>

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document
      .getElementById("tipo_servico_id")
      .addEventListener("change", function () {
        const tipoId = this.value;
        if (!tipoId) return;
        fetch(`/nota/api/responsavel/${tipoId}`)
          .then((res) => res.json())
          .then(
            (data) =>
              (document.getElementById("responsavel").value =
                data.responsavel || "")
          )
          .catch(() => (document.getElementById("responsavel").value = ""));
      });

    fetch("/nota/api/itens")
      .then((response) => response.json())
      .then((data) => {
        const select = document.getElementById("descricao");
        data.forEach((item) => {
          const option = document.createElement("option");
          option.value = item.codigo;
          option.dataset.valor = item.valor;
          option.textContent = item.descricao;
          select.appendChild(option);
        });
      });

    document
      .getElementById("descricao")
      .addEventListener("change", function () {
        const selected = this.options[this.selectedIndex];
        document.getElementById("codigo").value = selected.value || "";
        document.getElementById("valor").value = selected.dataset.valor || "";
      });
  });

  function adicionarItem() {
    const codigo = document.getElementById("codigo").value.trim();
    const descricao =
      document.getElementById("descricao").options[
        document.getElementById("descricao").selectedIndex
      ].text;
    const quantidade = document.getElementById("quantidade").value.trim();
    let valor = document.getElementById("valor").value.trim().replace(",", ".");

    if (!codigo || !quantidade) {
      alert("Selecione um item e informe a quantidade.");
      return;
    }

    valor = parseFloat(valor || 0).toFixed(2);

    const tabela = document.getElementById("tabela-itens");
    const row = document.createElement("tr");
    row.innerHTML = `
    <td><input type="hidden" name="codigo[]" value="${codigo}">${codigo}</td>
    <td>${descricao}</td>
    <td><input type="hidden" name="quantidade[]" value="${quantidade}">${quantidade}</td>
    <td><input type="hidden" name="valor[]" value="${valor}">R$ ${valor.replace(
      ".",
      ","
    )}</td>
    <td><button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">Excluir</button></td>
  `;
    tabela.appendChild(row);

    document.getElementById("codigo").value = "";
    document.getElementById("descricao").value = "";
    document.getElementById("quantidade").value = "";
    document.getElementById("valor").value = "";
  }

  function limparItens() {
    document.getElementById("tabela-itens").innerHTML = "";
  }

  function validarItens() {
    const tabela = document.getElementById("tabela-itens");
    if (tabela.rows.length === 0) {
      alert("Adicione ao menos um item antes de salvar a nota fiscal!");
      return false;
    }
    return true;
  }

  document
    .getElementById("importarExcel")
    .addEventListener("change", function (e) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
        rows.slice(1).forEach((row) => {
          if (row[0] && row[2])
            adicionarItemImportado(row[0], row[1], row[2], row[3]);
        });
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    });

  function adicionarItemImportado(codigo, descricao, quantidade, valor) {
    valor = parseFloat((valor || "0").toString().replace(",", ".")).toFixed(2);
    const tabela = document.getElementById("tabela-itens");
    const row = document.createElement("tr");
    row.innerHTML = `
    <td><input type="hidden" name="codigo[]" value="${codigo}">${codigo}</td>
    <td>${descricao}</td>
    <td><input type="hidden" name="quantidade[]" value="${quantidade}">${quantidade}</td>
    <td><input type="hidden" name="valor[]" value="${valor}">R$ ${valor.replace(
      ".",
      ","
    )}</td>
    <td><button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">Excluir</button></td>
  `;
    tabela.appendChild(row);
  }
</script>
{% endblock %}
